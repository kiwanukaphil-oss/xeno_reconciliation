// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// CORE ENTITIES
// ============================================================================

model Client {
  id         String   @id @default(uuid())
  clientName String
  clientCode String?  @unique
  status     ClientStatus @default(ACTIVE)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  accounts            Account[]
  fundTransactions    FundTransaction[]
  bankGoalTransactions BankGoalTransaction[]

  @@index([clientName])
  @@index([status])
  @@map("clients")
}

model Account {
  id              String   @id @default(uuid())
  clientId        String
  accountNumber   String   @unique
  accountType     AccountType
  accountCategory AccountCategory
  sponsorCode     String?  // Optional: for group/employer sponsored accounts
  status          AccountStatus @default(ACTIVE)

  openedAt        DateTime?
  closedAt        DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  client               Client @relation(fields: [clientId], references: [id], onDelete: Cascade)
  goals                Goal[]
  fundTransactions     FundTransaction[]
  bankGoalTransactions BankGoalTransaction[]

  @@index([clientId])
  @@index([accountNumber])
  @@index([sponsorCode])
  @@index([status])
  @@map("accounts")
}

model Goal {
  id               String   @id @default(uuid())
  accountId        String
  goalNumber       String   @unique
  goalTitle        String
  goalType         GoalType @default(OTHER)

  targetAmount     Decimal? @db.Decimal(18, 2)
  targetDate       DateTime?
  riskTolerance    RiskTolerance @default(MODERATE)

  // Fund distribution percentages (must sum to 100)
  // Example: { "XUMMF": 40, "XUBF": 30, "XUDEF": 20, "XUREF": 10 }
  fundDistribution Json

  status           GoalStatus @default(ACTIVE)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  account              Account @relation(fields: [accountId], references: [id], onDelete: Cascade)
  fundTransactions     FundTransaction[]
  bankGoalTransactions BankGoalTransaction[]

  @@index([accountId])
  @@index([goalNumber])
  @@index([status])
  @@map("goals")
}

model Fund {
  id           String   @id @default(uuid())
  fundCode     String   @unique
  fundName     String
  fundType     FundType
  currency     String   @default("UGX")
  inceptionDate DateTime?
  currentNAV   Decimal? @db.Decimal(18, 6)
  status       FundStatus @default(ACTIVE)

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  fundTransactions FundTransaction[]
  fundPrices       FundPrice[]

  @@index([fundCode])
  @@index([status])
  @@map("funds")
}

model FundPrice {
  id         String   @id @default(uuid())
  fundId     String
  priceDate  DateTime @db.Date

  bidPrice   Decimal  @db.Decimal(18, 6) // Buy-back price
  offerPrice Decimal  @db.Decimal(18, 6) // Selling price
  midPrice   Decimal  @db.Decimal(18, 6) // Average price
  nav        Decimal? @db.Decimal(18, 6) // Net Asset Value

  createdAt  DateTime @default(now())

  // Relations
  fund       Fund @relation(fields: [fundId], references: [id], onDelete: Cascade)

  @@unique([fundId, priceDate])
  @@index([priceDate])
  @@map("fund_prices")
}

// ============================================================================
// FUND TRANSACTIONS (Core transaction table)
// ============================================================================

model FundTransaction {
  id                   String   @id @default(uuid())

  // *** DEDUPLICATION FIELD ***
  // External unique identifier from source system to prevent duplicate uploads
  fundTransactionId    String   @unique

  // *** CRITICAL LINKING FIELD ***
  // Links related fund transactions belonging to same goal transaction
  // Format: {YYYY-MM-DD}-{accountNumber}-{goalNumber}
  // Example: "2018-07-24-701-555863519-701-5558635193a"
  goalTransactionCode  String

  // *** SOURCE TRACKING FIELDS ***
  // Transaction ID from source statement (e.g., bank statement)
  // Must be consistent across all fund transactions with same goalTransactionCode
  // Optional for backward compatibility with existing records
  transactionId        String?

  // Transaction source/channel
  // Must be consistent across all fund transactions with same goalTransactionCode
  // Optional for backward compatibility with existing records
  source               TransactionSource?

  // Foreign Keys
  clientId             String
  accountId            String
  goalId               String
  fundId               String
  uploadBatchId        String

  // Transaction Details
  transactionDate      DateTime @db.Date
  dateCreated          DateTime // System creation/processing date
  transactionType      TransactionType

  // Unit Trust Details
  amount               Decimal  @db.Decimal(18, 2) // Amount in currency
  units                Decimal  @db.Decimal(18, 6) // Units issued/redeemed
  bidPrice             Decimal  @db.Decimal(18, 6)
  offerPrice           Decimal  @db.Decimal(18, 6)
  midPrice             Decimal  @db.Decimal(18, 6)
  priceDate            DateTime @db.Date

  // Additional Fields
  reference            String?
  notes                String?

  // Variance Review Fields (for goal comparison review workflow - unmatched goal transactions)
  reviewTag            VarianceReviewTag?
  reviewNotes          String?  @db.Text
  reviewedAt           DateTime?
  reviewedBy           String?

  // Variance Resolution Tracking (tracks when tagged variances are resolved by subsequent uploads)
  varianceResolved     Boolean   @default(false)
  resolvedAt           DateTime?
  resolvedReason       String?   @db.Text  // How/why it was resolved
  resolvedByBatchId    String?   // The upload batch that resolved the variance

  // Audit Fields
  rowNumber            Int      // Original CSV row number
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  // Relations
  client               Client @relation(fields: [clientId], references: [id], onDelete: Restrict)
  account              Account @relation(fields: [accountId], references: [id], onDelete: Restrict)
  goal                 Goal @relation(fields: [goalId], references: [id], onDelete: Restrict)
  fund                 Fund @relation(fields: [fundId], references: [id], onDelete: Restrict)
  uploadBatch          UploadBatch @relation(fields: [uploadBatchId], references: [id], onDelete: Restrict)

  @@unique([uploadBatchId, rowNumber]) // Prevent duplicate rows from same upload
  @@index([fundTransactionId]) // For deduplication checks
  @@index([goalTransactionCode]) // Critical for grouping
  @@index([transactionId]) // For source transaction tracking
  @@index([source]) // For source-based queries
  @@index([transactionDate])
  @@index([clientId])
  @@index([accountId])
  @@index([goalId])
  @@index([fundId])
  @@index([transactionType])
  @@index([reviewTag]) // For filtering by review tag
  @@index([varianceResolved]) // For filtering resolved/unresolved variances
  @@index([transactionDate, accountId, goalId]) // Composite index for common queries
  @@map("fund_transactions")
}

// ============================================================================
// UPLOAD BATCH MANAGEMENT
// ============================================================================

model UploadBatch {
  id                  String   @id @default(uuid())
  batchNumber         String   @unique // Auto-generated: BATCH-YYYYMMDD-XXXXX
  fileName            String
  fileSize            BigInt
  filePath            String

  // Processing Status
  processingStatus    ProcessingStatus @default(QUEUED)
  validationStatus    ValidationStatus @default(PENDING)

  // Statistics
  totalRecords        Int      @default(0)
  processedRecords    Int      @default(0)
  failedRecords       Int      @default(0)

  // New Entity Detection
  newClientsDetected  Int      @default(0)
  newAccountsDetected Int      @default(0)
  newGoalsDetected    Int      @default(0)
  newEntitiesReport   Json?    // List of new entities for approval
  newEntitiesStatus   EntityApprovalStatus?

  // Financial Summary
  totalDepositAmount     Decimal @default(0) @db.Decimal(18, 2)
  totalWithdrawalAmount  Decimal @default(0) @db.Decimal(18, 2)
  totalUnitsIssued       Decimal @default(0) @db.Decimal(18, 6)
  totalUnitsRedeemed     Decimal @default(0) @db.Decimal(18, 6)

  // Fund breakdown: { XUMMF: { transactions, amount, units }, ... }
  fundBreakdown       Json?

  // Goal transaction statistics
  totalGoalTransactions      Int @default(0)
  completeGoalTransactions   Int @default(0) // Goal transactions with all 4 funds
  incompleteGoalTransactions Int @default(0)

  // Validation Results
  validationErrors    Json?    // Array of error objects
  validationWarnings  Json?    // Array of warning objects

  // Timestamps
  uploadedAt          DateTime @default(now())
  processingStartedAt DateTime?
  processingCompletedAt DateTime?

  // User Tracking
  uploadedBy          String
  approvedBy          String?
  approvedAt          DateTime?

  // Metadata: { period, source, notes, etc. }
  metadata            Json?

  // Relations
  fundTransactions    FundTransaction[]
  invalidRecords      InvalidFundTransaction[]

  @@index([processingStatus])
  @@index([validationStatus])
  @@index([uploadedAt])
  @@index([uploadedBy])
  @@map("upload_batches")
}

model InvalidFundTransaction {
  id              String   @id @default(uuid())
  uploadBatchId   String

  rowNumber       Int
  rawData         Json     // Original CSV row data
  validationErrors Json    // Array of validation error objects

  createdAt       DateTime @default(now())

  // Relations
  uploadBatch     UploadBatch @relation(fields: [uploadBatchId], references: [id], onDelete: Cascade)

  @@index([uploadBatchId])
  @@map("invalid_fund_transactions")
}

// ============================================================================
// VALIDATION CONFIGURATION
// ============================================================================

model ValidationRule {
  id                String   @id @default(uuid())
  ruleName          String   @unique
  ruleType          ValidationRuleType
  isActive          Boolean  @default(true)
  severity          ValidationSeverity

  // Rule-specific configuration (JSON)
  // Example: { "minValue": 1000, "maxValue": 1000000000 }
  configuration     Json

  errorMessage      String
  suggestedAction   String?

  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([ruleType])
  @@index([isActive])
  @@map("validation_rules")
}

// ============================================================================
// BANK RECONCILIATION
// ============================================================================

model BankUploadBatch {
  id                  String   @id @default(uuid())
  batchNumber         String   @unique // Auto-generated: BANK-BATCH-YYYYMMDD-XXXXX
  fileName            String
  fileSize            BigInt
  filePath            String

  // Processing Status
  processingStatus    ProcessingStatus @default(QUEUED)
  validationStatus    ValidationStatus @default(PENDING)

  // Statistics
  totalRecords        Int      @default(0)
  processedRecords    Int      @default(0)
  failedRecords       Int      @default(0)

  // Reconciliation Summary
  totalMatched        Int      @default(0)
  totalUnmatched      Int      @default(0)
  totalVariances      Int      @default(0)
  autoApprovedCount   Int      @default(0)
  manualReviewCount   Int      @default(0)

  // Financial Summary
  totalAmount         Decimal  @default(0) @db.Decimal(18, 2)
  varianceAmount      Decimal  @default(0) @db.Decimal(18, 2)

  // Validation Results
  validationErrors    Json?    // Array of error objects
  validationWarnings  Json?    // Array of warning objects

  // Timestamps
  uploadedAt          DateTime @default(now())
  processingStartedAt DateTime?
  processingCompletedAt DateTime?

  // User Tracking
  uploadedBy          String
  approvedBy          String?
  approvedAt          DateTime?

  // Metadata: { period, source, notes, etc. }
  metadata            Json?

  // Relations
  bankGoalTransactions BankGoalTransaction[]

  @@index([processingStatus])
  @@index([validationStatus])
  @@index([uploadedAt])
  @@index([uploadedBy])
  @@map("bank_upload_batches")
}

model BankGoalTransaction {
  id                  String   @id @default(uuid())

  // Foreign Keys
  clientId            String
  accountId           String
  goalId              String
  uploadBatchId       String

  // Transaction Details
  transactionDate     DateTime @db.Date
  transactionType     TransactionType
  transactionId       String   // Bank transaction ID

  // Client Information (from CSV)
  firstName           String
  lastName            String
  goalTitle           String

  // Goal Transaction Data
  goalNumber          String   // For matching
  totalAmount         Decimal  @db.Decimal(18, 2)

  // Fund Distribution Percentages
  xummfPercentage     Decimal  @db.Decimal(5, 4) // e.g., 0.4000 for 40%
  xubfPercentage      Decimal  @db.Decimal(5, 4)
  xudefPercentage     Decimal  @db.Decimal(5, 4)
  xurefPercentage     Decimal  @db.Decimal(5, 4)

  // Fund Distribution Amounts
  xummfAmount         Decimal  @db.Decimal(18, 2)
  xubfAmount          Decimal  @db.Decimal(18, 2)
  xudefAmount         Decimal  @db.Decimal(18, 2)
  xurefAmount         Decimal  @db.Decimal(18, 2)

  // Reconciliation Status
  reconciliationStatus ReconciliationStatus @default(PENDING)
  matchedGoalTransactionCode String?  // goalTransactionCode from FundTransaction if matched

  // Matching Metadata
  matchedAt           DateTime?
  matchScore          Int?     // Confidence score (0-100)

  // Variance Review Fields (for goal comparison review workflow)
  reviewTag           VarianceReviewTag?
  reviewNotes         String?  @db.Text
  reviewedAt          DateTime?
  reviewedBy          String?

  // Variance Resolution Tracking (tracks when tagged variances are resolved by subsequent uploads)
  varianceResolved     Boolean   @default(false)
  resolvedAt           DateTime?
  resolvedReason       String?   @db.Text  // How/why it was resolved
  resolvedByBatchId    String?   // The upload batch that resolved the variance

  // Audit Fields
  rowNumber           Int      // Original CSV row number
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  client              Client @relation(fields: [clientId], references: [id], onDelete: Restrict)
  account             Account @relation(fields: [accountId], references: [id], onDelete: Restrict)
  goal                Goal @relation(fields: [goalId], references: [id], onDelete: Restrict)
  uploadBatch         BankUploadBatch @relation(fields: [uploadBatchId], references: [id], onDelete: Restrict)
  variances           ReconciliationVariance[]

  @@unique([uploadBatchId, rowNumber]) // Prevent duplicate rows from same upload
  @@index([reconciliationStatus])
  @@index([transactionDate])
  @@index([clientId])
  @@index([accountId])
  @@index([goalId])
  @@index([goalNumber])
  @@index([transactionId])
  @@index([matchedGoalTransactionCode])
  @@index([reviewTag]) // For filtering by review tag
  @@index([varianceResolved]) // For filtering resolved/unresolved variances
  @@index([goalNumber, transactionId, totalAmount]) // Composite index for matching
  @@map("bank_goal_transactions")
}

model ReconciliationVariance {
  id                      String   @id @default(uuid())
  bankGoalTransactionId   String

  // Variance Details
  varianceType            VarianceType
  varianceSeverity        VarianceSeverity
  description             String   @db.Text

  // Amounts
  expectedValue           Decimal? @db.Decimal(18, 2)
  actualValue             Decimal? @db.Decimal(18, 2)
  differenceAmount        Decimal? @db.Decimal(18, 2)
  differencePercentage    Decimal? @db.Decimal(5, 2)

  // Fund-specific variance (if applicable)
  fundCode                String?
  fundExpectedAmount      Decimal? @db.Decimal(18, 2)
  fundActualAmount        Decimal? @db.Decimal(18, 2)

  // Date variance (if applicable)
  expectedDate            DateTime? @db.Date
  actualDate              DateTime? @db.Date
  dateDifferenceDays      Int?

  // Resolution
  resolutionStatus        VarianceResolutionStatus @default(PENDING)
  resolutionNotes         String?  @db.Text
  resolvedBy              String?
  resolvedAt              DateTime?

  // Auto-approval
  autoApproved            Boolean  @default(false)
  autoApprovalReason      String?

  // Audit
  detectedAt              DateTime @default(now())
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  bankGoalTransaction     BankGoalTransaction @relation(fields: [bankGoalTransactionId], references: [id], onDelete: Cascade)

  @@index([varianceType])
  @@index([varianceSeverity])
  @@index([resolutionStatus])
  @@index([bankGoalTransactionId])
  @@index([fundCode])
  @@map("reconciliation_variances")
}

// ============================================================================
// ENUMS
// ============================================================================

enum ClientStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
}

enum AccountType {
  PERSONAL
  CORPORATE
  JOINT
  POOLED
  LINKED
  SPONSOR
}

enum AccountCategory {
  GENERAL
  RETIREMENT
  EDUCATION
  TRUST
  INVESTMENT_CLUBS
  RETIREMENTS_BENEFIT_SCHEME
  FAMILY
  SACCO
}

enum AccountStatus {
  ACTIVE
  CLOSED
  SUSPENDED
}

enum GoalType {
  EDUCATION
  RETIREMENT
  WEALTH
  EMERGENCY
  OTHER
}

enum RiskTolerance {
  CONSERVATIVE
  MODERATE
  BALANCED
  AGGRESSIVE
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  SUSPENDED
  CANCELED
}

enum FundType {
  EQUITY
  BOND
  MONEY_MARKET
  BALANCED
}

enum FundStatus {
  ACTIVE
  CLOSED
  SUSPENDED
}

enum TransactionType {
  DEPOSIT
  WITHDRAWAL
  REDEMPTION
  SWITCH
  DIVIDEND
  TRANSFER
}

enum ProcessingStatus {
  QUEUED
  PARSING
  VALIDATING
  PROCESSING
  WAITING_FOR_APPROVAL
  COMPLETED
  FAILED
  CANCELED
}

enum ValidationStatus {
  PENDING
  PASSED
  FAILED
  WARNING
}

enum EntityApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ValidationRuleType {
  REQUIRED_FIELD
  DATE_VALIDATION
  AMOUNT_VALIDATION
  UNITS_VALIDATION
  PRICE_VALIDATION
  BUSINESS_RULE
  GOAL_TRANSACTION_CONSISTENCY
  FUND_DISTRIBUTION
}

enum ValidationSeverity {
  CRITICAL
  WARNING
  INFO
}

enum TransactionSource {
  Transfer_Reversal
  AIRTEL_APP
  MTN_USSD
  AIRTEL_WEB
  MTN_APP
  MTN_WEB
  BANK
  MTN_MOMO
  AIRTEL_MONEY
  RT_Adjustment
}

enum ReconciliationStatus {
  PENDING           // Awaiting matching
  MATCHED           // Matched with fund transaction
  VARIANCE_DETECTED // Matched but has variances
  AUTO_APPROVED     // Variances auto-approved
  MANUAL_REVIEW     // Requires manual review
  APPROVED          // Manually approved
  REJECTED          // Rejected/disputed
  MISSING_IN_FUND   // No matching fund transaction found
}

enum VarianceType {
  TOTAL_AMOUNT      // Total amount mismatch
  FUND_DISTRIBUTION // Fund distribution percentage mismatch
  FUND_AMOUNT       // Individual fund amount mismatch
  DATE_DIFFERENCE   // Transaction date difference
  MISSING_IN_BANK   // Present in fund system but not in bank
  MISSING_IN_FUND   // Present in bank but not in fund system
}

enum VarianceSeverity {
  LOW      // < 1,000 UGX
  MEDIUM   // 1,000 - 10,000 UGX
  HIGH     // 10,000 - 50,000 UGX
  CRITICAL // > 50,000 UGX
}

enum VarianceResolutionStatus {
  PENDING           // Awaiting resolution
  AUTO_APPROVED     // Auto-approved within tolerance
  APPROVED          // Manually approved
  REJECTED          // Rejected as error
  INVESTIGATING     // Under investigation
  RESOLVED          // Resolved/explained
}

enum VarianceReviewTag {
  DUPLICATE_TRANSACTION   // Transaction appears twice
  NO_ACTION_NEEDED        // Variance is expected/acceptable
  MISSING_IN_BANK         // Transaction in goals but not in bank
  MISSING_IN_GOAL         // Transaction in bank but not in goals
  TIMING_DIFFERENCE       // Date mismatch, will reconcile later
  AMOUNT_DISCREPANCY      // Amounts don't match
  DATA_ENTRY_ERROR        // Incorrect data entry
  UNDER_INVESTIGATION     // Needs further investigation
  REVERSAL_NETTED         // Paired with a reversal transaction (net zero)
}
